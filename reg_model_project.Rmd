---
title: "Modeling and prediction for movies"
output:
  html_document:
    fig_height: 4
    highlight: pygments
    theme: spacelab
    Author: Varshit Dubey (COE PUNE)
  pdf_document: default
---

## Setup

### Load packages

```{r load-packages, message = FALSE}
library(ggplot2)
library(dplyr)
library(statsr)
library(ggthemes)
library(corrgram)
library(corrplot)
library(caTools)
```

### Load data


```{r load-data}
load("movies.Rdata")

```



* * *

## Part 1: Data

The data set is comprised of 651 randomly sampled movies produced and released before 2016.

Since random sampling is used in the collection of data set and no assignment is used ,this is an observational study, not experimental. 

We can only find correlation between variables and because of random sampling we can generalize the result to all the movies. We cannot find any causal relation as there is no random assignment(observational).


* * *

## Part 2: Research question

By looking at the data set the basic question which arises in mind is:

What makes the movie succesfull??

Which variables contributes to the critic's rating in the movie??

Does genre, audience score affects the critic's rating of rotten tomatoes(if particular genre movie has more chance of success)??

All this question can be addressed by linear modelling..

This research question will help to search for the factors that affects the score of critics, which factors to consider while making a review..

* * *

## Part 3: Exploratory data analysis
```{r}
# Explore the data set 
# Explore the first 10 observations
head(movies, 10)

tail(movies, 10)
```


```{r}
# explore the variables of movies data set
str(movies)

```


```{r}

# explore various statistical concepts of variables of movies data set
summary(movies)

```

Now we start to dig deeper in the data set.

```{r}


a3 <- movies %>% group_by(genre) %>% filter(!is.na(genre) , !is.na(imdb_rating)) %>% summarise(meanrating= mean(imdb_rating)) %>% arrange(desc(meanrating))

a3

```

This result shows movies with genre "Documentary " has the highest average rating in IMDB while comedy has the lowest average rating.

```{r}

# filtering the data according to the variables of interest.

a0 <- movies %>% group_by(genre) %>% filter(!is.na(genre), !is.na(critics_score)) %>% summarise(meancritic=mean(critics_score),meanaudience = mean(audience_score)) %>% mutate(diff = meanaudience- meancritic) %>% arrange(desc(diff))

a0
```

This table shows the average rating given by critics and audience based on genre. As you can see from the table there is difference in rating. So we can say that audience and critics and audience have different taste of movies.

```{r}
# average of difference between audience and critcs rating based on genre

movies %>% mutate(diff = audience_score - critics_score) %>% group_by(genre) %>% summarise(m = mean(diff)) %>% arrange(desc(m))

```


And the second table shows the differece in audience and  critics rating on rotten tomatoes.The above result shows that Audience tend to like  "Action and adventure" movies while Critics give them low ratings on average.


```{r, fig.width= 12, fig.height= 8}
# Looking at the data by some visualization..

ggplot(data= movies , aes(x= audience_score ,y= critics_score)) + 
  geom_point(size = 5) + geom_smooth(method= "lm",se= FALSE) + ggtitle("Plot of Audience vs Critic's Ratings") 

```

The above plot shows there is positive linear relation between audience and critic scores.
Let's make this plot more attractive.

```{r, fig.height= 8, fig.width= 12}

ggplot(data= movies , aes(x= audience_score ,y= critics_score)) + geom_point(mapping = aes(colour = genre), size = 5) + geom_smooth(method= "lm",se= FALSE) + ggtitle("Plot of Audience vs Critic's Ratings") +  
  theme_bw() + xlab("Audience Score") +ylab("Critics Score") + 
  theme(plot.title = element_text(size = 20, 
                                  face = "bold",
                                  hjust = 0.5))

```

```{r, fig.height= 12, fig.showtext= 5, dpi=100, fig.width= 15, out.height= "200px"}
mod_movies <- movies %>% filter(audience_score >= 50) 

ggplot(mod_movies, aes(critics_score, audience_score, color = genre)) + geom_point(aes(size = critics_rating), fill = 0.7) + geom_text(aes(label = ifelse(audience_score >= 50 & critics_score < 20, as.character(title),''),
                                                                                                                                           hjust = 0.5,vjust = -2), size = 6, face = "bold") + xlab("Critics Score") + 
  ylab("Audience Score more than 50")  + 
  ggtitle("Scatter plot between Audience and Critics Rating") +
  theme_bw(base_size = 20) + 
  theme(plot.title = element_text(size = 30, face = "bold", hjust = 0.5, colour = "Blue"), 
        axis.title.x = element_text(size = 20, colour = "Dark Green"), 
        axis.title.y = element_text(size = 20, colour = "Dark Green"))

```

I selected rows whose audience_score is more than 50 and stored the new data frame.

And I plot the scatterplot, between critics_score an audience_score, and also added size and colour to make it more beautiful. Ignore the warning.

Conclusion - Surely there are some movies whose critics_score is less than 20 but audience rated it more than 50. I highlighted these movies. Interesting.

Audience rated some movies even more than 80 while critics rated it less than even 25, for ex. see the movie "Rise of the Footsoldier".

Now we try to make a scatterplot which shows the plot based on individual levels of categorical variables, like a grid.

```{r, fig.width= 12, fig.height= 8}

ggplot(movies) + geom_point(mapping = aes(audience_score, critics_score)) + 
  facet_grid(mpaa_rating~genre) +
  labs(title = "Facet grid based on genre and Mpaa rating") + 
  theme_bw() + 
  theme(axis.title.x = element_text(size = 20, colour = "Red"), 
        axis.title.y = element_text(size = 20, colour = "Red"), 
        plot.title = element_text(size = 30, hjust = 0.5, colour = "Dark Blue", face = "bold"), 
        axis.title.x.top = element_text(size = 10))

```

Now let's try to make scatter plot with another variables..

```{r, fig.width=12, fig.height=8}

ggplot(data= movies, aes(x= imdb_num_votes, y = imdb_rating)) + 
  geom_point(aes(colour = genre), size = 3, alpha = 0.6) + 
  geom_jitter(aes(colour = genre)) + xlab("Imdb Number of votes") + 
  ggtitle("Plot showing relationship of Imdb rating with Imdb number of Votes")+ 
  ylab("Imdb Rating") + 
  theme_bw(base_size = 17)  + 
  theme(plot.title = element_text(hjust = 0.5, size = 20, colour = "Red"), 
        axis.title.x = element_text(size = 15, colour = "Brown"), 
        axis.title.y = element_text(size = 15, colour = "Brown"))

```

The plot is very dense for imdb_num_vote less than 125,000. Greater than 125,000 the points are very scattered. Also one can infer that if the Imdb number of votes is greater than 300,000 or 500,000, chances are that the Imdb rating of that movie is greater than 7.5 or 8, so greater is the no. of votes more is the imdb_rating.

```{r, fig.width= 15, fig.height= 15}

movies %>% 
  mutate(diff = audience_score - critics_score) %>% 
  ggplot(aes(genre,diff))  + 
  geom_jitter(aes(colour = mpaa_rating,size = critics_rating)) + 
  geom_boxplot(aes(fill = genre, alpha = 0.1),show.legend = F,outlier.shape = NA) + 
  theme_bw(base_size = 30) + labs(y = "Difference in Audience and Critics", x = "Genre", title = "Boxplot of difference in audience and critics rating") + 
  theme(plot.title = element_text(size = 30, face = "bold", hjust = 0.5, colour = "Dark Green"), 
        axis.title.x = element_text(size = 30, colour = "Red"), 
        axis.title.y = element_text(size = 30, colour = "Red"), 
        axis.text.x = element_text(angle = 45, colour = "Blue", hjust = 1, size = 20), 
        legend.key.size = unit(2,"line"), 
        legend.title = element_text(colour = "blue", face = "bold"),
        legend.text = element_text(face = "bold"))

```

The above boxplot shows the distribution of observations of difference in audience and critics score, based on different genres. We can see that audience tend to score the movie more than critics for most of the genre as their the median of many boxplots is more than 0, but for some genres like "Documentary" the median is less than 0, means critics tend to score more than audience in this case.

```{r}
# Now we find correlation coefficient between all the numeric variables of the data set.

# Removing missing values

dat <- movies %>% 
  filter(!is.na(runtime), !is.na(dvd_rel_day), !is.na(dvd_rel_month), !is.na(dvd_rel_year))

# Grab only numeric columns
num.cols <- sapply(dat, is.numeric)

# Filter to numeric columns for correlation
cor.data <- cor(dat[,num.cols])

cor.data

```

```{r, fig.width= 10, fig.height= 8}

# Making correlation plot.

corrplot(cor.data,method='color')

```

The plot shown in the figure visualises the big correlation table we made, now it becomes easier to make conclusions regarding which variables are more correlated to each other and which are not as it is difficult to make conclusions based on just observing the correlation matrix. The more a box is blue, more correlated are the 2 variables which made that box. As expected, audience score, critics_score, imdb_rating, are somewhat more correlated to each other than the rest.


Now we make a histogram of imdb rating of movies and see the type of distribution.

```{r, fig.width= 12, fig.height= 8}

ggplot(data = movies, aes(x = imdb_rating)) + 
  geom_histogram(mapping = aes(fill = genre), colour = "black", binwidth = 1) + 
  theme_bw() + 
  labs(title = "Histogram of IMDB rating of Movies", x = "IMDB Rating", y = "Count") + 
  theme(plot.title = element_text(size = 20, face = "bold", color = "Brown", hjust = 0.5), 
        axis.title.x = element_text(face = "bold", color = "Blue", size = 15), 
        axis.title.y = element_text(face = "bold", color = "blue", size = 15))

```

In this histogram we also segregated the count by different genre, like in a range of imdb_rating, which genre has how many movie. We can see that the distribution of imdb_rating is slightly left skewed.

Now let's see another visual..

```{r, fig.width= 15, fig.height= 8}

ggplot(movies, aes(mpaa_rating)) +  
  geom_bar(aes(fill = genre), color = "black", position = "dodge") + 
  labs(title = "Bar Plot of Mpaa rating", y = "Count", x = "Mpaa rating") +  
  theme_bw(base_size = 15) + 
  theme(plot.title = element_text(hjust = 0.5, size = 25, face = "bold", color = "Dark Blue"), 
        axis.title.x = element_text(size = 20, face = "bold", colour = "Brown"), 
        axis.title.y = element_text(size = 20, face = "bold", colour = "Brown"), 
        axis.text.x = element_text(size = 20, colour = "Dark Green"), 
        legend.title = element_text(colour = "Purple", size = 15), 
        legend.text = element_text(size = 15, colour = "Blue")) 

```

This bar plot shows count of various mpaa rating of movies with genre, one can see from the graph that "Horrer" movies are mostly rated "R", most of the movies in our data set are "R" rated, with "G" category the least. 


* * *

## Part 4: Modeling


To make a model, I am going to predict the critcs score of rotten tomatoes. 

I am not using the variables "actor1" to "actor5" as they are statistically insignificant variables, also I am not adding release date variables as they are also statistically insignificant variables. Though I think year and month can have significant role to play in the model as this data set contains information of movies as old as 1970's and I think there is a steady transformation in the critic score and their thinking for a movie from 1970 to 2016. 

I am not including "title" as the movie title name is of no use, also I removed "studio", though it can have some effect on our model, but there are 211 studio in our data set, some studio has 1 or 2 movies some have even more than 30, it will only add confusion to our model, so I removed studio variable. You can add studio in your model if you want.

```{r}
# data preprocessing step
# Removing some variables which are statistically insignificant.
mod_data <- movies %>% select(-c(director:rt_url), -title, -thtr_rel_day, -dvd_rel_day, -studio)

# Removing or replacing Missing values
mod_data$runtime <- ifelse(is.na(mod_data$runtime), mean(mod_data$runtime, na.rm = T), mod_data$runtime)

mod_data <- mod_data %>% filter(!is.na(dvd_rel_year), !is.na(dvd_rel_month))

# Dividing the data into training and test set

set.seed(123)
split = sample.split(mod_data$critics_score, SplitRatio = 0.70)
training_set = subset(mod_data,split == T)
test_set = subset(mod_data, split == F)

```


First of all, I am going to add all the variables in the model and use backward elimination to make the final model. I am going to do backward elimination by 'Adjusted R squared technique' as I think this method gives good robust results and also I look at p- values of variables in the model to do backward elimination, the significance level will be 0.05 for p-value.

```{r}

#assumed model

m1 <- lm(critics_score ~. , data= training_set)

summary(m1)


```

Now comparing p-value of all variables in the model, we see that "best_actress_win" variable has the highest p-value, so we will remove the variable.

```{r}
# without genre
str(training_set)
m2 <- lm(critics_score ~ title_type + genre + runtime + mpaa_rating + thtr_rel_year + thtr_rel_month +
           dvd_rel_year + dvd_rel_month + imdb_rating + imdb_num_votes + critics_rating + 
           audience_rating + audience_score + best_pic_nom + best_pic_win + best_actor_win + 
           best_dir_win + top200_box, data= training_set)

summary(m2)

```

We see that in our model now the adjusted R squared value is increased a bit, which is what we want, now looking at the model again we find that "audience_score" has the highest p-value now, so we will remove the variable.

```{r}
# without audience_score..

m3 <- lm(critics_score ~ title_type + genre + runtime + mpaa_rating + thtr_rel_year + thtr_rel_month +
           dvd_rel_year + dvd_rel_month + imdb_rating + imdb_num_votes + critics_rating + 
           audience_rating + best_pic_nom + best_pic_win + best_actor_win + 
           best_dir_win + top200_box, data= training_set)

summary(m3)


```

Looking again at the model we will remove "best_actor_win" as it's p-value is highest.

```{r}
# without best_actor_win variable..

m4 <- lm(critics_score ~ title_type + genre + runtime + mpaa_rating + thtr_rel_year + thtr_rel_month +
           dvd_rel_year + dvd_rel_month + imdb_rating + imdb_num_votes + critics_rating + 
           audience_rating + best_pic_nom + best_pic_win + 
           best_dir_win + top200_box, data= training_set)

summary(m4)


```

We will remove "best_pic_win" variable as it's p-value is highest.

```{r}
# removing best_pic_win variable

m5 <- lm(critics_score ~ title_type + genre + runtime + mpaa_rating + thtr_rel_year + thtr_rel_month +
           dvd_rel_year + dvd_rel_month + imdb_rating + imdb_num_votes + critics_rating + 
           audience_rating + best_pic_nom + 
           best_dir_win + top200_box, data= training_set)

summary(m5)

```

Every time we remove variable, our Adjusted R-squared value is increasing. Now we will remove "genre" variable as p-value is very high for all the levels of "genre" variable.

```{r}
# without genre 

m6 <- lm(critics_score ~ title_type + runtime + mpaa_rating + thtr_rel_year + thtr_rel_month +
           dvd_rel_year + dvd_rel_month + imdb_rating + imdb_num_votes + critics_rating + 
           audience_rating + best_pic_nom + 
           best_dir_win + top200_box, data= training_set)

summary(m6)


```

But we see that even though we removed genre variable our Adjusted R Squared value is reduced, so we will include genre in our model and now we remove "mpaa_rating" variable.

```{r}
# without mpaa_rating

m7 <- lm(critics_score ~ title_type + genre + runtime + thtr_rel_year + thtr_rel_month +
           dvd_rel_year + dvd_rel_month + imdb_rating + imdb_num_votes + critics_rating + 
           audience_rating + best_pic_nom + 
           best_dir_win + top200_box, data= training_set)

summary(m7)

```

Now we will remove "audience_rating" variable.

```{r}
# without audience_rating variable.

m9 <- lm(critics_score ~ title_type + genre + runtime + thtr_rel_year + thtr_rel_month +
           dvd_rel_year + dvd_rel_month + imdb_rating + imdb_num_votes + critics_rating + 
           best_pic_nom + 
           best_dir_win + top200_box, data= training_set)

summary(m9)


```

Now we will remove "best_pic_nom"

```{r}
# Without best_pic_nom variable

m10 <- lm(critics_score ~ title_type + genre + runtime + thtr_rel_year + thtr_rel_month +
           dvd_rel_year + dvd_rel_month + imdb_rating + imdb_num_votes + critics_rating + 
           best_dir_win + top200_box, data= training_set)

summary(m10)

```


Removing "runtime" variable..

```{r}
# removing runtime variable

m11 <- lm(critics_score ~ title_type + genre + thtr_rel_year + thtr_rel_month +
           dvd_rel_year + dvd_rel_month + imdb_rating + imdb_num_votes + critics_rating + 
           best_dir_win + top200_box, data= training_set)

summary(m11)

```

Now we will remove "thtr_rel_month". 

```{r}
# removing thtr_rel_month
m12 <- lm(critics_score ~ title_type + genre + thtr_rel_year +
           dvd_rel_year + dvd_rel_month + imdb_rating + imdb_num_votes + critics_rating + 
           best_dir_win + top200_box, data= training_set)

summary(m12)

```

We see that removing "thtr_rel_month" our Adjusted R squared value is same but we will not include "thtr_rel_month" variable as it's p-value is very high so it does not add anything useful in our model. Now Removing "best_director_win" variable.

```{r}

m13 <- lm(critics_score ~ title_type + genre + thtr_rel_year +
           dvd_rel_year + dvd_rel_month + imdb_rating + imdb_num_votes + critics_rating + 
           top200_box, data= training_set)

summary(m13)

```

Now removing "top200_box" variable.

```{r}
m14 <- lm(critics_score ~ title_type + genre + thtr_rel_year +
           dvd_rel_year + dvd_rel_month + imdb_rating + imdb_num_votes + critics_rating, data= training_set)

summary(m14)

```

Now removing "dvd_rel_month" variable..

```{r}
# removing dvd_rel_month variable..

m15 <- lm(critics_score ~ title_type + genre + thtr_rel_year +
           dvd_rel_year + imdb_rating + imdb_num_votes + critics_rating, data= training_set)

summary(m15)

```

Removing "dvd_rel_year"..

```{r}

m16 <- lm(critics_score ~ title_type + genre + thtr_rel_year +
           imdb_rating + imdb_num_votes + critics_rating, data= training_set)

summary(m16)

```

We see that our Adjusted R squared values decreses by small value so we will include "dvd_rel_year" variable. Now we remove "title_type" variable..

```{r}
m17 <- lm(critics_score ~ genre + thtr_rel_year +
           imdb_rating + imdb_num_votes + critics_rating, data= training_set)

summary(m17)
```

We see that adjusted R -squared value is decreased by a large amount, so we will include "title_type" variable in our model. Now we see that there are no more variable we can remove as p-value of rest variable is less than 0.05, and by removing variables with p value greater than 0.05 our Adjusted R squared value decreases so we cannot remove them. So this is the final model.

```{r}
# Final Model 

m18 <- lm(critics_score ~ genre + title_type + thtr_rel_year +
           imdb_rating + imdb_num_votes + critics_rating + dvd_rel_year, data= training_set)

summary(m18)

```


Interpretations of model coefficients:

Consider the intercept in the final model. This shows that if a "Certified Fresh", "action and adventure" movie with title type of "TV Movie" doesn't mention it's year of release , number of voters in IMDB, IMDB rating and it's dvd release year then it's critic's rating is likely to be 1.604e+02.

For categorical variables like "genre", "title_type" and "critics_rating", one level of the variable is kept 0 which means that the level which is made 0, doesn't affect the critic rating of the movie. And the interpretation of other levels is made by keeping one level 0.

Considering the theatre release year variables, we can interpret that keeping rest of the variables constant, for a unit increase in year the critic score of rotten tomatoes decreases by about 2.404e-01.

Consider the imdb_num_votes variables,  keeping rest of the variables constant, for unit increase in IMDB voters the critic rating is likely to decrease by 1.284e-05.  

For ex. keeping other variables constant we can say that, on average, animation movies have critic's rating greater than Action and Adventure by 2.036e+00.

Model Diagnostics:

So we made our model. Now we check conditions required for multiple regression to be mapped valid.

1. The first condition is the linear relationship between numerical x and response variable. We can check this using residual plot with x variable(numerical).

```{r}

plot(m18$residuals ~ training_set$audience_score)

```

```{r}

plot(m18$residuals ~ training_set$thtr_rel_year)

```

So we can see there is random scatter around 0.

2. The second condition for model diagnstics is nearly normal residual with mean 0.We can check it through histogram or we can see ot through normal probability plot.

```{r}
# plot with normal probability plot.
qqnorm(m18$residuals)
qqline(m18$residuals)
```

```{r}

# Grab residuals
res <- residuals(m18)

# Convert to DataFrame for gglpot
res <- as.data.frame(res)

head(res)
# Histogram of residuals
ggplot(res,aes(res)) +  geom_histogram(fill='blue',alpha=0.7, binwidth = 3) + xlab("Residuals") + ggtitle("Histogram Of Residuals") + theme_bw() + theme(plot.title = element_text(hjust = 0.5, colour = "Brown", face = "bold"))
# or you can do the same with 
hist(m18$residuals)

```

We can see that the distribution of residuals is nearly normal. 

3. The third condition is constant variability of the residuals. We can do this by checking residuals plots vs predicted value.

```{r}
ggplot(data = m18, aes(x = .fitted, y = (.resid))) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed") + theme_bw()

```

We can say to an extent that there is constant variability in the residuals.  

4. The last diagnostic method is independent residuals.The independent residuals comes from independent observations.

```{r}

plot(m18$residuals)


```

By looking at the plot there is random scatter about 0 and therefore we can say that the residuals are independent .


* * *

## Part 5: Prediction

Now we see how our model predicted the test data, we will use predict() function for this purpose.

```{r}

model.predictions <- predict(m18,  test_set)
results <- cbind(model.predictions,test_set$critics_score) 
colnames(results) <- c('pred','real')
results <- as.data.frame(results)
head(results,10)

```

So we can see the predicted and original value, we can see that our model is not that bad, we made some great predictions, like for example in results data frame see 3rd observation, predicted is 69.263, and actual is 67. Also see 6th observation, real critic score is 19 and our model predicted 19.04 which is same, so great our model is good.

```{r}
# Maximum value of prediction 
max(results$pred)

```

But when we look at the maximum value of our prediction, we see that it is 102.0408, we know that rotten tomatoes maximum score is 100. So we need to add certain restriction to our model so that our prediction doesn't exceeds 100. We can do it by making simple fucntion.

```{r}

greater_hundred <- function(x){
    if  (x > 100){
        return(100)
    }else{
        return(x)
    }
}

results$pred <- sapply(results$pred,greater_hundred)

```

Now I'm going to predict the rotten tomatoes rating of one of my favourite movie of 2016 "Deadpool".

Information regarding audience_score, genre can be found at https://www.rottentomatoes.com/m/deadpool/

and regarding imdb_num_votes can be found at http://www.imdb.com/title/tt1431045/ratings?ref_=tt_ov_rt

Information regarding genre can be found on https://www.imdb.com/title/tt1431045/?ref_=tt_rt

dvd is released on May 2016,can be found by clicking this link https://www.imdb.com/title/tt1431045/?ref_=tt_rt

Deadpool is certified fresh which can be found on https://www.rottentomatoes.com/m/deadpool/ 

Now we have information regarding all the variables needed to make our model, we will put all in a data frame,

```{r}
# Taking information from a particualar movie which is not in the data set..

newmovie <- data.frame( genre= "Action & Adventure",thtr_rel_year = 2016, title_type = "Feature Film", imdb_rating = 8, imdb_num_votes = 747563, critics_rating = "Certified Fresh", dvd_rel_year = 2016)

```

Now let's see what our model predicts.

```{r}
# predicting the value of critics score for the newmovie..

predict(m18, newmovie)

```

So our predicted value for rotten tomatoes critics rating is 81.43938 while the actual critic score which is available on rotten romatoes site is 83 as given on the site. So we can say that our model can approximately predicts the critic score of rotten tomatoes.


We can also construct a prediction interval around this prediction, which will
provide a measure of uncertainty around the prediction.

```{r}
#predicting newmovie confidence interval for the value of critics score..

predict(m18, newmovie, interval = "prediction", level = 0.95)

```

The number 104.0521 is mere a number for confidence interval and as we know that  critic score cannot exceed 100 so we can restrict our upper limit of confidence to 100.
The above statement says that "We are 95% confident that the movie  "DEADPOOL"  will get critics score on average between 58.82663 and 100 by Rotten tomatoes."


* * *

## Part 6: Conclusion

After making model and doing prediction, we can predict critic review of any movie given the specific parameters which are required for our model.

Thus we can find the factors which decides the success of the movie,like Imdb Rating, genre etc, 
but we need more parameters(variables) to make more accurate prediction of the review as for now we can only approximate our findings based on the variables given in the data set. Like say "Box Office" and "Budget" can also play a very important role in predicting the crtics score of movie, like wise there are many.

The model can be used to predict the success rate of movie and by adding some input variables in the data set we can improve the performance of the model. 

